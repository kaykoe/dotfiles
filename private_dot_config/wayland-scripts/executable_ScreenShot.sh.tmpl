#!/bin/bash
# /* ---- üí´ https://github.com/JaKooLit üí´ ---- */  ##
# Screenshots scripts

{{- $gui_packages := dig .osid "gui" ( list ) .packages }}
{{- $is_hyprland := has "hyprland" $gui_packages }}
{{- $is_sway := has "sway" $gui_packages }}

# variables
time=$(date "+%d-%b_%H-%M-%S")
dir="$(xdg-user-dir PICTURES)/Screenshots"
file="Screenshot_${time}_${RANDOM}.png"

iDIR="$HOME/.config/swaync/icons"
iDoR="$HOME/.config/swaync/images"
sDIR="$HOME/.config/wayland-scripts"

{{- if $is_hyprland }}
active_window_class=$(hyprctl -j activewindow | jq -r '(.class)')
{{- else if $is_sway }}
active_window_class=$(swaymsg -t get_tree | jq -r '.. | select(.focused?) | .app_id // .window_properties.class')
{{- end }}
active_window_file="Screenshot_${time}_${active_window_class}.png"
active_window_path="${dir}/${active_window_file}"

notify_cmd_base="notify-send -t 10000 -A action1=Open -A action2=Delete"
notify_cmd_shot="${notify_cmd_base} -i ${iDIR}/picture.png "
notify_cmd_shot_win="${notify_cmd_base} -i ${iDIR}/picture.png "
notify_cmd_NOT="notify-send -u low -i ${iDoR}/note.png "

# notify and view screenshot
notify_view() {
	if [[ "$1" == "active" ]]; then
		if [[ -e "${active_window_path}" ]]; then
			"${sDIR}/Sounds.sh" --screenshot
			resp=$(timeout 5 ${notify_cmd_shot_win} " Screenshot of:" " ${active_window_class} Saved to $file")
			case "$resp" in
			action1)
				xdg-open "${active_window_path}" &
				;;
			action2)
				rm "${active_window_path}" &
				;;
			esac
		else
			${notify_cmd_NOT} " Screenshot of:" " ${active_window_class} NOT Saved."
			"${sDIR}/Sounds.sh" --error
		fi
	else
		local check_file="${dir}/${file}"
		if [[ -e "$check_file" ]]; then
			"${sDIR}/Sounds.sh" --screenshot
			resp=$(timeout 5 ${notify_cmd_shot} " Screenshot" " Saved to $file")
			case "$resp" in
			action1)
				xdg-open "${check_file}" &
				;;
			action2)
				rm "${check_file}" &
				;;
			esac
		else
			${notify_cmd_NOT} " Screenshot" " NOT Saved"
			"${sDIR}/Sounds.sh" --error
		fi
	fi
}

# take shots
shotnow() {
	cd ${dir} && grim - | tee "$file" | wl-copy
	sleep 0.1
	notify_view
}

shotwin() {
{{- if $is_hyprland }}
	w_pos=$(hyprctl activewindow | grep 'at:' | cut -d':' -f2 | tr -d ' ' | tail -n1)
	w_size=$(hyprctl activewindow | grep 'size:' | cut -d':' -f2 | tr -d ' ' | tail -n1 | sed s/,/x/g)
	cd ${dir} && grim -g "$w_pos $w_size" - | tee "$file" | wl-copy
{{- else if $is_sway }}
	swaymsg -t get_tree | jq -r '.. | select(.focused?) | "\(.rect.x),\(.rect.y) \(.rect.width)x\(.rect.height)"' | grim -g - - | tee "${dir}/${file}" | wl-copy
{{- end }}
	sleep 0.1
	notify_view
}

shotactive() {
{{- if $is_hyprland }}
	hyprctl -j activewindow | jq -r '"\(.at[0]),\(.at[1]) \(.size[0])x\(.size[1])"' | grim -g - - | tee "${active_window_path}" | wl-copy
{{- else if $is_sway }}
	swaymsg -t get_tree | jq -r '.. | select(.focused?) | "\(.rect.x),\(.rect.y) \(.rect.width)x\(.rect.height)"' | grim -g - - | tee "${active_window_path}" | wl-copy
{{- end }}
	sleep 0.1
	notify_view "active"
}

shotarea() {
	tmpfile=$(mktemp)
	grim -g "$(slurp)" - >"$tmpfile"

	# Copy with saving
	if [[ -s "$tmpfile" ]]; then
		wl-copy <"$tmpfile"
		mv "$tmpfile" "$dir/$file"
	fi
	notify_view
}

menu() {

	## Author  : Aditya Shakya (adi1090x)
	## Github  : @adi1090x
	#
	## Applets : Screenshot (Ported to use Grimblast)

	## Modify
	## Author  : Gon√ßalo Duarte (MrDuartePT)
	## Github  : @MrDuartePT
	##
	## Github  : @Xartoks

	## Port for Grimblast (https://github.com/hyprwm/contrib/tree/main/grimblast)

	menu_command="rofi"
	# Options
	# main_opts=("Û∞πë Capture" "Û∞Å´ Timer capture")
	screenshot_opts=("Û∞çπ Screen" "Ôãê Active Window" "Ôãí Window" "Û±£¥ Capture Area")
	action_opts=("ÓØå Copy" "Ó≠ã Save" "Ó≠ã Copy &amp; Save" "ÔÄü Edit")

	# Detect available menu program
	define_menu() {
		if ! command -v $menu_command; then
			if command -v wofi >/dev/null 2>&1; then
				menu_command="wofi"
			elif command -v rofi >/dev/null 2>&1; then
				menu_command="rofi"
			elif command -v walker >/dev/null 2>&1; then
				menu_command="walker"
			else
				echo "No menu program found (wofi, rofi, walker)" >&2
				exit 1
			fi
		fi
	}

	# Show menu based on detected command
	show_menu() {
		prompt="$1"
		shift
		menu_opts=("$@") # global array
		case $menu_command in
		"wofi") wofi_menu ;;
		"rofi") rofi_menu ;;
		"walker") walker_menu ;;
		esac
	}

	wofi_menu() {
		printf '%s\n' "${menu_opts[@]}" | wofi --dmenu --prompt "$prompt" -m
	}

	rofi_menu() {
		printf '%s\n' "${menu_opts[@]}" | rofi \
			-dmenu \
			-p "$prompt" \
			-markup-rows
	}

	walker_menu() {
		printf '%s\n' "${menu_opts[@]}" | walker -p "$prompt" -d
	}

	define_menu

	type_choice=$(show_menu "Type Of Screenshot" "${screenshot_opts[@]}") || exit 1
	case "$type_choice" in
	"Û∞çπ Screen") shotnow ;;
	"Ôãê Active Window") shotactive ;;
	"Ôãí Window") shotwin ;;
	"Û±£¥ Capture Area") shotarea ;;
	esac
}

if [[ ! -d "$dir" ]]; then
	mkdir -p "$dir"
fi

if [[ "$1" == "--now" ]]; then
	shotnow
elif [[ "$1" == "--win" ]]; then
	shotwin
elif [[ "$1" == "--area" ]]; then
	shotarea
elif [[ "$1" == "--active" ]]; then
	shotactive
elif [[ "$#" == 0 ]]; then
	menu
else
	echo -e "Available Options : --now --win --area --active"
fi

exit 0
