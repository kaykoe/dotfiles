#!/bin/bash
# /* ---- ðŸ’« https://github.com/JaKooLit ðŸ’« ---- */  ##
# Wallust Colors for current wallpaper

{{- $gui_packages := dig .osid "gui" ( list ) .packages }}
{{- $is_hyprland := has "hyprland" $gui_packages }}
{{- $is_sway := has "sway" $gui_packages }}

# Define the path to the swww cache directory
cache_dir="$HOME/.cache/swww/"

# Get a list of monitor outputs
monitor_outputs=($(ls "$cache_dir"))

# Initialize a flag to determine if the ln command was executed
ln_success=false

{{- if $is_hyprland }}
# Get current focused monitor
current_monitor=$(hyprctl monitors | awk '/^Monitor/{name=$2} /focused: yes/{print name}')
{{- else if $is_sway }}
# Get current focused monitor
current_monitor=$(swaymsg -t get_outputs | jq -r '.[] | select(.focused) | .name')
{{- end }}
echo $current_monitor
# Construct the full path to the cache file
cache_file="$cache_dir$current_monitor"
echo $cache_file
# Check if the cache file exists for the current monitor output
if [ -f "$cache_file" ]; then
	# Get the wallpaper path from the cache file
	wallpaper_path=$(grep -vz 'Lanczos3' "$cache_file" | head -n 1)
	echo $wallpaper_path
	# symlink the wallpaper to the location Rofi can access
	if ln -sf "$wallpaper_path" "$HOME/.config/rofi/.current_wallpaper"; then
		ln_success=true # Set the flag to true upon successful execution
	fi
	cp -r "$wallpaper_path" "$HOME/.config/wallpaper/current"
fi

# Check the flag before executing further commands
if [ "$ln_success" = true ]; then
	# execute wallust
	echo 'about to execute wallust'
	# execute wallust skipping tty and terminal changes
	sed -Ei 's/^#((\w+)\.(target|template) = .*$)/\1/' ~/.config/wallust/wallust.toml
	sed -Ei 's/^((kitty|neopywal)\.(target|template) = .*$)/#\1/' ~/.config/wallust/wallust.toml
	wallust run "$wallpaper_path" -s
	sed -Ei 's/^((\w+)\.(target|template) = .*$)/#\1/' ~/.config/wallust/wallust.toml
	sed -Ei 's/^#((kitty|neopywal)\.(target|template) = .*$)/\1/' ~/.config/wallust/wallust.toml
fi
