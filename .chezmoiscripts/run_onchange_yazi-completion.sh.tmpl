#!/usr/bin/env bash

{{- $version := printf "v%s" ( ( split " " ( output "yazi" "-V" ) )._1 | trim ) }}
{{- $cli_packages := dig .osid "cli" ( list ) .packages }}
{{- $comp_exists := not (glob ".bash_completions/yazi.bash" | empty) }}

# {{ print "yazi version: " $version }}
# {{ print "completion file exists: " $comp_exists }}

{{- if not (has "yazi" $cli_packages) }}
set -e

tmpdir="$(mktemp -d)"
trap 'rm -rf "$tmpdir"' EXIT

wget -qO "${tmpdir}/yazi.zip" https://github.com/sxyazi/yazi/releases/latest/download/yazi-x86_64-unknown-linux-musl.zip
unzip -j "${tmpdir}/yazi.zip" -d "$tmpdir" '*/completions/yazi.bash' '*/completions/_yazi' '*/completions/ya.bash' '*/completions/_ya'

mkdir -p ~/.bash_completions
command mv "${tmpdir}/yazi.bash" ~/.bash_completions/
command mv "${tmpdir}/ya.bash" ~/.bash_completions/

{{ if .zsh -}}
mkdir -p ~/.zsh_completions
command mv "${tmpdir}/_yazi" ~/.zsh_completions/
command mv "${tmpdir}/_ya" ~/.zsh_completions/
{{- end }}

{{- end }}
