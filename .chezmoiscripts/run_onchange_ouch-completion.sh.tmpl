#!/usr/bin/env bash

{{- $version := printf "%s" ( ( split " " ( output "ouch" "-V" ) )._1 | trim ) }}
{{- $cli_packages := dig .osid "cli" ( list ) .packages }}
{{- $comp_exists := not (glob ".bash_completions/ouch.bash" | empty) }}
{{- $man_exists := not (glob ".man/man1/ouch.1" | empty) }}

# {{ print "ouch version: " $version }}
# {{ print "completion file exists: " $comp_exists }}
# {{ print "man file exists: " $man_exists }}

{{- if not (has "ouch" $cli_packages) }}
set -e

tmpdir="$(mktemp -d)"
trap 'rm -rf "$tmpdir"' EXIT

wget -qO- {{ gitHubReleaseAssetURL "ouch-org/ouch" $version "ouch-x86_64-unknown-linux-musl.tar.gz" }} | tar -C "$tmpdir" --strip-components 1 -xz

mkdir -p ~/.man/man1
command mv -t ~/.man/man1 "${tmpdir}"/man/*

mkdir -p ~/.bash_completions
command mv -t ~/.bash_completions "${tmpdir}/completions/ouch.bash"

{{ if .zsh -}}
mkdir -p ~/.zsh_completions
command mv -t ~/.zsh_completions "${tmpdir}/completions/_ouch"
{{- end }}

{{- end }}
